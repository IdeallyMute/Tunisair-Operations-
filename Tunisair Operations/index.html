<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunisair - Booking & Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Auth Page */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #C8444A 0%, #A03038 100%);
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
        }
        
        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            animation: scaleIn 0.5s ease-out;
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 30px;
            animation: slideUp 0.6s ease-out;
        }
        
        .logo-section img {
            height: 60px;
            margin-bottom: 15px;
        }
        
        .logo-section h1 {
            font-size: 28px;
            color: #C8444A;
            margin-bottom: 8px;
            animation: slideIn 0.7s ease-out;
        }
        
        .logo-section p {
            color: #666;
            font-size: 14px;
            animation: slideIn 0.8s ease-out;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #C8444A;
            border-bottom-color: #C8444A;
        }
        
        .form-group {
            margin-bottom: 20px;
            animation: slideUp 0.5s ease-out;
            animation-fill-mode: both;
        }
        
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #C8444A;
            box-shadow: 0 0 0 3px rgba(200, 68, 74, 0.1);
            transform: translateY(-2px);
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: #C8444A;
            color: white;
            width: 100%;
            animation: slideUp 0.6s ease-out 0.5s;
            animation-fill-mode: both;
        }
        
        .btn-primary:hover {
            background: #A03038;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(200, 68, 74, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover { background: #e0e0e0; }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .hidden { display: none; }
        
        .message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        
        .success-message {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }
        
        /* Navigation Bar */
        .navbar {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #C8444A;
            animation: slideIn 0.7s ease-out;
        }
        
        .navbar-logo img { 
            height: 40px;
        }
        
        .navbar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Search Section */
        .search-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            animation: slideIn 0.7s ease-out;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .search-field {
            display: flex;
            flex-direction: column;
            animation: slideUp 0.5s ease-out;
            animation-fill-mode: both;
        }
        
        .search-field:nth-child(1) { animation-delay: 0.1s; }
        .search-field:nth-child(2) { animation-delay: 0.2s; }
        .search-field:nth-child(3) { animation-delay: 0.3s; }
        .search-field:nth-child(4) { animation-delay: 0.4s; }
        .search-field:nth-child(5) { animation-delay: 0.5s; }
        
        .search-field label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-field select,
        .search-field input {
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .search-field select:focus,
        .search-field input:focus {
            outline: none;
            border-color: #C8444A;
        }
        
        .search-actions {
            display: flex;
            gap: 15px;
        }
        
        /* Flight Cards */
        .flights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
        }
        
        .flight-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            animation: slideUp 0.5s ease-out;
            animation-fill-mode: both;
            cursor: pointer;
        }
        
        .flight-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(200, 68, 74, 0.2);
            border-color: #C8444A;
        }
        
        .flight-card:active {
            transform: translateY(-4px) scale(1.01);
        }
        
        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f5f5f5;
        }
        
        .flight-number {
            font-size: 20px;
            font-weight: 700;
            color: #C8444A;
        }
        
        .flight-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-scheduled { background: #e8f4f8; color: #2196F3; }
        .status-delayed { background: #f8d7da; color: #721c24; }
        .status-done, .status-completed { background: #e8f5e9; color: #2e7d32; }
        .status-departed { background: #e8f5e9; color: #4CAF50; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        th.sortable { cursor: pointer; user-select: none; }
        th.sortable::after { content: ' ‚Üï'; color: #bbb; font-weight: 400; }
        
        .flight-route {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .city {
            flex: 1;
        }
        
        .city-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .city-time {
            font-size: 14px;
            color: #999;
            margin-top: 4px;
        }
        
        .route-arrow {
            color: #C8444A;
            font-size: 24px;
        }
        
        .flight-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .flight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .price-section {
            text-align: left;
        }
        
        .price-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .price {
            font-size: 28px;
            font-weight: 700;
            color: #C8444A;
        }
        
        .btn-book {
            padding: 14px 32px;
            background: #C8444A;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-book:hover {
            background: #A03038;
            transform: translateY(-2px);
        }
        
        /* Admin Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            position: relative;
        }

        /* KPI info bubble */
        .kpi-info {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(47,111,237,0.12);
            color: #2F6FED;
            font-weight: 800;
            font-size: 13px;
            cursor: help;
        }
        .kpi-info::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 0;
            top: 30px;
            min-width: 260px;
            max-width: 360px;
            padding: 12px 14px;
            border-radius: 14px;
            background: #111;
            color: #fff;
            font-size: 13px;
            line-height: 1.35;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-4px);
            transition: all 0.15s ease;
            z-index: 200;
        }
        .kpi-info:hover::after {
            opacity: 1;
            transform: translateY(0);
        }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 30px rgba(200, 68, 74, 0.15);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #C8444A;
            margin-bottom: 8px;
            overflow-wrap: anywhere;
            word-break: break-word;
            line-height: 1.05;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #C8444A;
        }

        /* 3-state sortable headers with clear arrow feedback */
        th.sortable {
            cursor: pointer;
            position: relative;
            padding-right: 28px;
            user-select: none;
        }
        th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #bdbdbd;
            font-size: 12px;
        }
        th.sortable[data-sort-dir="asc"]::after {
            content: '‚ñ≤';
            color: #6b7280;
        }
        th.sortable[data-sort-dir="desc"]::after {
            content: '‚ñº';
            color: #6b7280;
        }
        
        /* Bookings */
        .bookings-grid {
            display: grid;
            gap: 20px;
        }
        
        .booking-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #C8444A;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
            animation-fill-mode: both;
        }
        
        .booking-card:nth-child(1) { animation-delay: 0.1s; }
        .booking-card:nth-child(2) { animation-delay: 0.2s; }
        .booking-card:nth-child(3) { animation-delay: 0.3s; }
        .booking-card:nth-child(4) { animation-delay: 0.4s; }
        .booking-card:nth-child(5) { animation-delay: 0.5s; }
        
        .booking-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(200, 68, 74, 0.15);
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }
        
        .booking-ref {
            font-size: 18px;
            font-weight: 700;
            color: #C8444A;
            margin-bottom: 5px;
        }
        
        .booking-date {
            font-size: 13px;
            color: #999;
        }
        
        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .booking-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-header {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        
        .close-modal {
            font-size: 32px;
            color: #999;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .booking-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .summary-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-top: 12px;
            border-top: 2px solid #C8444A;
        }
        
        .summary-label {
            color: #666;
            font-size: 14px;
        }
        
        .summary-value {
            font-weight: 600;
            color: #333;
        }
        
        .total-price {
            font-size: 24px;
            font-weight: 700;
            color: #C8444A;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
        }
        
        .empty-state h3 {
            font-size: 22px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #999;
        }
        
        /* Phone Input with Country Code */
        .phone-input-group {
            display: flex;
            gap: 10px;
        }
        
        .country-code-select {
            width: 120px;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .country-code-select:focus {
            outline: none;
            border-color: #C8444A;
        }
        
        .phone-number-input {
            flex: 1;
        }
        
        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .admin-tab {
            padding: 15px 30px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
        }
        
        .admin-tab.active {
            color: #C8444A;
            border-bottom-color: #C8444A;
        }

        /* Sticky analytics filters (Dashboards tab) */
        .sticky-analytics {
            position: sticky;
            top: 84px; /* below header */
            z-index: 50;
            background: #fafafa;
            padding: 14px 14px;
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        }
        
        .admin-tab:hover {
            color: #C8444A;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Aircraft Modal */
        .aircraft-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px 15px 0 0;
            margin-bottom: 20px;
        }
        
        .aircraft-image-placeholder {
            width: 100%;
            height: 250px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px 15px 0 0;
            margin-bottom: 20px;
            color: #999;
            font-size: 18px;
        }
        
        /* Country/City Search */
        .search-field-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .optional-label {
            font-size: 11px;
            color: #999;
            font-style: italic;
        }
        
        /* Detail Panel Styles (from dashboard.html) */
        .detail-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #C8444A;
        }
        
        .detail-box-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .detail-box-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        /* Currency Selector */
        .currency-selector {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .currency-selector label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        
        .currency-selector select {
            border: 2px solid #e0e0e0;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            background: white;
        }
        
        /* Map Container */
        .map-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-top: 30px;
        }
        
        .map-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        #routeMap {
            width: 100%;
            height: 450px;
            border-radius: 14px;
            background: #f1f3f5;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        
        /* Phone Validation Status */
        .phone-validation {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .phone-validation.valid {
            background: #d4edda;
            color: #155724;
        }
        
        .phone-validation.invalid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .phone-validation.checking {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* API Status Indicator */
        .api-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 11px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .api-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .api-status-dot.active {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }
        
        .api-status-dot.inactive {
            background: #dc3545;
        }
        
        @media (max-width: 768px) {
            .flights-grid {
                grid-template-columns: 1fr;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
        }
    
#scrollTopBtn{
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:9999;
    display:none;
    border:none;
    background:#d71920;
    color:white;
    width:44px;
    height:44px;
    border-radius:999px;
    font-size:18px;
    box-shadow:0 10px 25px rgba(0,0,0,0.15);
    cursor:pointer;
    transition: transform .15s ease, opacity .15s ease;
}
#scrollTopBtn:hover{ transform: translateY(-2px); }
.sortable{
    cursor:pointer;
    user-select:none;
    position:relative;
    padding-right:22px;
}
.sort-indicator{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    font-size:10px;
    color:#bbb;
}
.sortable.sorted-asc .sort-indicator{ color:#111; }
.sortable.sorted-desc .sort-indicator{ color:#111; }
.status-pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    line-height:1;
    letter-spacing:.2px;
    border:1px solid rgba(0,0,0,0.06);
}
.status-scheduled{ background:rgba(37,99,235,.12); color:#2563eb; }
.status-delayed{ background:rgba(220,38,38,.12); color:#dc2626; }
.status-done, .status-confirmed{ background:rgba(22,163,74,.12); color:#16a34a; }

/* KPI layout: featured Total Revenue card */
.kpi-layout{
    display:flex;
    gap:14px;
    align-items:stretch;
}
.kpi-feature{
    flex: 1 1 320px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    border: 2px solid rgba(229, 33, 46, 0.22);
    min-width: 260px;
}
.kpi-grid{
    flex: 2 1 0;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:14px;
}
.stat-value{
    font-size: clamp(18px, 2.2vw, 34px);
    line-height: 1.1;
    word-break: break-word;
}
@media (max-width: 980px){
    .kpi-layout{ grid-template-columns: 1fr; }
    .kpi-feature{ grid-row: auto; }
    .kpi-grid{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
}


/* Map UI polish */
.map-controls{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.map-controls .btn{
    border-radius:12px;
}
.map-filter{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 12px;
    background:#fff;
    border:1px solid #eee;
    border-radius:14px;
    box-shadow: 0 8px 26px rgba(0,0,0,0.06);
}
.map-filter label{
    font-size:12px;
    font-weight:700;
    color:#666;
}

</style>
</head>
<body>
    <!-- Auth Page -->
    <div id="authPage" class="auth-page">
        <div class="auth-container">
            <div class="logo-section">
                <img src="Tunisair.png" alt="Tunisair" onerror="this.style.display='none'" />
                <h1>Welcome to Tunisair</h1>
                <p>Book your next journey with us</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="login" onclick="switchTab('login')">Login</button>
                <button class="tab" data-tab="register" onclick="switchTab('register')">Register</button>
            </div>
            
            <div id="authMessage" class="hidden"></div>
            
            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" required />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required />
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" class="form-input" placeholder="Choose a username" required />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" class="form-input" placeholder="Enter your email" required />
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="regPhone" class="form-input" placeholder="e.g. +216 12 345 678" />
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regFullName" class="form-input" placeholder="Enter your full name" required />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="Create a password" required />
                </div>
                <button type="submit" class="btn btn-primary">Register</button>
            </form>
        </div>
    </div>

    <!-- User Booking Page -->
    <div id="userPage" class="hidden" style="background: #f5f7fa; min-height: 100vh;">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-logo">
                    <img src="Tunisair.png" alt="Tunisair" onerror="this.style.display='none'" />
                    <span>Tunisair Booking</span>
                </div>
                <div class="navbar-actions">
                    <span class="user-name" id="userName"></span>
                    <div class="currency-selector" style="margin: 0 15px;">
                        <label style="margin-right: 5px;">üí±</label>
                        <select id="currencySelect" onchange="updateCurrency()" style="padding: 8px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                            <option value="TND">TND DT</option>
                            <option value="TND">TND $</option>
                            <option value="GBP">GBP ¬£</option>
                            <option value="TND" selected>TND</option>
                            <option value="AED">AED</option>
                            <option value="TRY">TRY</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="showMyBookings()">My Bookings</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
        
        <div class="container">
            <!-- Search Section -->
            <div class="search-section" id="searchSection">
                <h2 class="search-title">Find Your Perfect Flight</h2>
                
                <div class="search-grid">
                    <div class="search-field-group">
                        <div class="search-field">
                            <label>From Country</label>
                            <select id="departureCountry" class="form-input" onchange="updateDepartureCities()">
                                <option value="">Select Country</option>
                                <option value="Tunisia">Tunisia</option>
                                <option value="France">France</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Italy">Italy</option>
                                <option value="Spain">Spain</option>
                                <option value="Turkey">Turkey</option>
                                <option value="UAE">United Arab Emirates</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Germany">Germany</option>
                            </select>
                        </div>
                        <div class="search-field" id="departureCityField" style="display: none;">
                            <label>City / Airport <span class="optional-label">(Optional)</span></label>
                            <select id="departureCity" class="form-input">
                                <option value="">Any City</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-field-group">
                        <div class="search-field">
                            <label>To Country</label>
                            <select id="arrivalCountry" class="form-input" onchange="updateArrivalCities()">
                                <option value="">Select Country</option>
                                <option value="Tunisia">Tunisia</option>
                                <option value="France">France</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Italy">Italy</option>
                                <option value="Spain">Spain</option>
                                <option value="Turkey">Turkey</option>
                                <option value="UAE">United Arab Emirates</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Germany">Germany</option>
                            </select>
                        </div>
                        <div class="search-field" id="arrivalCityField" style="display: none;">
                            <label>City / Airport <span class="optional-label">(Optional)</span></label>
                            <select id="arrivalCity" class="form-input">
                                <option value="">Any City</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-field">
                        <label>Date</label>
                        <input type="date" id="flightDate" class="form-input" />
                    </div>
                    <div class="search-field">
                        <label>Passengers</label>
                        <select id="numPassengers" class="form-input">
                            <option value="1">1 Passenger</option>
                            <option value="2">2 Passengers</option>
                            <option value="3">3 Passengers</option>
                            <option value="4">4 Passengers</option>
                            <option value="5">5 Passengers</option>
                            <option value="6">6 Passengers</option>
                        </select>
                    </div>
                    <div class="search-field">
                        <label>Class</label>
                        <select id="ticketClass" class="form-input">
                            <option value="economy">Economy</option>
                            <option value="premium">Premium Economy</option>
                            <option value="business">Business Class</option>
                        </select>
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="searchFlights()" style="min-width: 200px;">
                        Search Flights
                    </button>
                    <button class="btn btn-secondary" onclick="showAllFlights()" style="min-width: 180px;">
                        Show All Flights
                    </button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>
            </div>
            
            <!-- Flights Section -->
            <div class="section" id="flightsSection">
                <div class="section-title">Available Flights <span id="resultsCount" style="float:right; font-size:14px; color:#999;"></span></div>
                <div class="flights-grid" id="flightsGrid"></div>
            </div>
            
            <!-- My Bookings Section -->
            <div class="section hidden" id="bookingsSection">
                <div class="section-title">
                    My Bookings
                    <button class="btn btn-secondary" style="float: right;" onclick="showSearchSection()">Back to Search</button>
                </div>
                <div class="bookings-grid" id="bookingsGrid"></div>
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-danger" onclick="deleteAccount()">Delete My Account</button>
                </div>
            </div>
            
            <!-- Route Map -->
            <div class="map-container">
                <h3>‚úàÔ∏è Tunisair Route Network</h3>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0 15px 0;">
                    <span style="font-size: 13px; color:#666; font-weight:600;">Map Date</span>
                    <button class="btn btn-secondary" style="padding:8px 12px;" onclick="shiftMapDate(-1)">‚óÄ</button>
                    <input type="date" id="mapDateFilter" class="form-input" style="max-width: 180px; padding: 10px;" onchange="refreshRouteMap()" />
                    <button class="btn btn-secondary" style="padding:8px 12px;" onclick="shiftMapDate(1)">‚ñ∂</button>
                    <button class="btn btn-secondary" style="padding:8px 12px;" onclick="refreshRouteMap(true)">Refresh</button>
                    <div style="display:flex; gap:10px; align-items:center; padding:6px 10px; border:1px solid #eee; border-radius:10px; background:#fff;">
                        <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#666; cursor:pointer; user-select:none;">
                            <input type="checkbox" id="mapShowScheduled" checked onchange="refreshRouteMap(true)" />
                            Scheduled
                        </label>
                        <label style="display:flex; gap:6px; align-items:center; font-size:12px; color:#666; cursor:pointer; user-select:none;">
                            <input type="checkbox" id="mapShowLive" checked onchange="refreshRouteMap(true)" />
                            Live
                        </label>
                    </div>
                    <span id="mapStatus" style="font-size:12px; color:#999;"></span>
                    <span id="mapClock" style="font-size:12px; color:#666; font-weight:600; margin-left:auto;"></span>
                </div>
                <div id="routeMap">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        üìç Interactive map loading...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Page -->
    <div id="adminPage" class="hidden" style="background: #f5f7fa; min-height: 100vh;">
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-logo">
                    <img src="Tunisair.png" alt="Tunisair" onerror="this.style.display='none'" />
                    <span>Tunisair Admin Dashboard</span>
                </div>
                <div class="navbar-actions">
                    <span class="user-name" id="adminName"></span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
        
        <div class="container">
            <!-- Statistics -->
            
<div class="kpi-layout">
    <div class="stat-card kpi-feature">
        <div class="kpi-info" data-tooltip="Total revenue from all bookings.">i</div>
        <div class="stat-value" id="totalRevenue">-</div>
        <div class="stat-label">Total Revenue (DT)</div>
    </div>
    <div class="kpi-grid">
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Total registered users.">i</div>
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Total bookings recorded in the system.">i</div>
            <div class="stat-value" id="totalBookings">-</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Average booking value.">i</div>
            <div class="stat-value" id="avgBookingValue">-</div>
            <div class="stat-label">Avg Booking (DT)</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Total passengers across all bookings(tickets summed).">i</div>
            <div class="stat-value" id="totalPassengers">-</div>
            <div class="stat-label">Total Passengers</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Total number of flights.">i</div>
            <div class="stat-value" id="totalFlights">-</div>
            <div class="stat-label">Total Flights</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Number of operational aircraft vs total aircraft.">i</div>
            <div class="stat-value" id="totalAircraft">-</div>
            <div class="stat-label">Aircraft Fleet</div>
        </div>
        <div class="stat-card">
            <div class="kpi-info" data-tooltip="Seat occupancy estimate based on booked seats vs available seats.">i</div>
            <div class="stat-value" id="occupancyRate">-</div>
            <div class="stat-label">Occupancy Rate</div>
        </div>
    </div>
</div>

            
            <!-- Admin Tabs -->
            <div class="admin-tabs" style="margin-top:14px;">
                <button class="admin-tab active" data-tab="userData" onclick="switchAdminTab('userData')">Dashboards</button>
                <button class="admin-tab" data-tab="operations" onclick="switchAdminTab('operations')">Internal Operations</button>
            </div>
            
            <!-- User Data Tab -->
            <div id="userDataTab" class="tab-content active">
                <!-- Slicers / Filters -->
                <div class="section sticky-analytics" style="margin-bottom: 20px;">
                    <div class="section-title">Analytics Filters</div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
                        <div style="min-width: 260px;">
                            <div style="font-size:12px; color:#666; font-weight:600; margin-bottom:6px;">Time (Range)</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button type="button" class="btn btn-secondary" style="padding:8px 10px;" onclick="shiftAdminDate(-1)">‚óÄ</button>
                                <div style="display:flex; gap:6px; flex:1;">
                                    <input id="analyticsStart" type="date" class="form-input" style="padding:10px; flex:1;">
                                    <input id="analyticsEnd" type="date" class="form-input" style="padding:10px; flex:1;">
                                </div>
                                <button type="button" class="btn btn-secondary" style="padding:8px 10px;" onclick="shiftAdminDate(1)">‚ñ∂</button>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <select id="analyticsGranularity" class="form-input" style="padding:10px; flex:1;">
                                    <option value="day" selected>Day</option>
                                    <option value="week">Week</option>
                                    <option value="month">Month</option>
                                    <option value="quarter">Quarter</option>
                                    <option value="year">Year</option>
                                </select>
                                <select id="analyticsDays" class="form-input" style="padding:10px; display:none;">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="180">Last 180 days</option>
                                </select>
                            </div>
                            <div style="margin-top:10px; font-size:12px; color:#666;">
                                <div style="font-weight:600; margin-bottom:4px;">Revenue Color Scale</div>
                                <div style="height:10px; border-radius:8px; background: linear-gradient(90deg, #E2E8F0, #2F6FED, #F59E0B, #C8444A);"></div>
                            </div>
                        </div>
                        <div style="min-width: 170px;">
                            <div style="font-size:12px; color:#666; font-weight:600; margin-bottom:6px;">Flight Class</div>
                            <select id="analyticsClass" class="form-input" style="padding:10px;">
                                <option value="">All</option>
                                <option value="economy">Economy</option>
                                <option value="premium">Premium</option>
                                <option value="business">Business</option>
                            </select>
                        </div>
                        <div style="min-width: 170px;">
                            <div style="font-size:12px; color:#666; font-weight:600; margin-bottom:6px;">Origin</div>
                            <select id="analyticsOrigin" class="form-input" style="padding:10px;">
                                <option value="">All</option>
                                <option value="Tunis">Tunis</option>
                                <option value="Monastir">Monastir</option>
                                <option value="Djerba">Djerba</option>
                                <option value="Enfidha">Enfidha</option>
                            </select>
                        </div>
                        <div style="min-width: 190px;">
                            <div style="font-size:12px; color:#666; font-weight:600; margin-bottom:6px;">Aircraft</div>
                            <select id="analyticsAircraft" class="form-input" style="padding:10px;">
                                <option value="">All</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" style="padding:10px 14px;" onclick="loadAdminData()">Apply</button>
                    </div>
                </div>
                <!-- Analytics Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <div class="section-title">Bookings Over Time</div>
                        <canvas id="bookingsChart" style="width:100%; height:300px;" height="300"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title">Revenue Trend</div>
                        <canvas id="revenueChart" style="width:100%; height:300px;" height="300"></canvas>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <span>Popular Routes</span>
                            <select class="form-input" style="padding:6px 10px; font-size:12px; max-width:140px;" onchange="setChartSort('routes', this.value)">
                                <option value="">Sort</option>
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <canvas id="routesChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <span>Bookings by Class</span>
                            <select class="form-input" style="padding:6px 10px; font-size:12px; max-width:140px;" onchange="setChartSort('class', this.value)">
                                <option value="">Sort</option>
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <canvas id="classChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <div class="section-title">User Growth</div>
                        <canvas id="userGrowthChart" style="width:100%; height:300px;" height="300"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title">Passengers per Day</div>
                        <canvas id="passengersChart" style="width:100%; height:300px;" height="300"></canvas>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <div class="section-title">Bookings by Status</div>
                        <canvas id="bookingStatusChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <span>Top Customers (Revenue)</span>
                            <select class="form-input" style="padding:6px 10px; font-size:12px; max-width:140px;" onchange="setChartSort('customers', this.value)">
                                <option value="">Sort</option>
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <canvas id="topCustomersChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="section">
                        <div class="section-title">Fleet Status</div>
                        <canvas id="fleetStatusChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title">Crew Status</div>
                        <canvas id="crewStatusChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="section">
                        <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <span>Maintenance by Type</span>
                            <select class="form-input" style="padding:6px 10px; font-size:12px; max-width:140px;" onchange="setChartSort('maint', this.value)">
                                <option value="">Sort</option>
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <canvas id="maintenanceTypeChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Lightweight heatmap (no external deps): top destinations by bookings -->
                <div class="section" style="margin-bottom: 10px;">
                    <div class="section-title">Destination Heatmap (Concept)</div>
                    <div id="locationHeatmap" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;"></div>
                    <div style="font-size:12px; color:#888; margin-top:8px;">Darker tiles = more bookings.</div>
                </div>
            </div>
            
            <!-- Internal Operations Tab -->
            <div id="operationsTab" class="tab-content">
                <!-- Fleet Management -->
                <div class="section">
                    <div class="section-title">Fleet Management</div>
                    <div style="overflow-x: auto;">
                        <table id="aircraftTable">
                            <thead>
                                <tr>
                                    <th class="sortable">Registration</th>
                                    <th class="sortable">Model</th>
                                    <th class="sortable">Manufacturer</th>
                                    <th class="sortable">Total Seats</th>
                                    <th class="sortable">Status</th>
                                    <th class="sortable">Flight Hours</th>
                                    <th class="sortable">Location</th>
                                </tr>
                            </thead>
                            <tbody id="aircraftTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Crew Management -->
                <div class="section">
                    <div class="section-title">Crew Management</div>
                    <div style="overflow-x: auto;">
                        <table id="crewTable">
                            <thead>
                                <tr>
                                    <th class="sortable">Employee ID</th>
                                    <th class="sortable">Full Name</th>
                                    <th class="sortable">Role</th>
                                    <th class="sortable">License Number</th>
                                    <th class="sortable">Flight Hours</th>
                                    <th class="sortable">Status</th>
                                    <th class="sortable">Base</th>
                                </tr>
                            </thead>
                            <tbody id="crewTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Maintenance Records -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="section-title">Maintenance Records</div>
                        <button class="btn btn-primary" onclick="openMaintenanceModal()">
                            + Add Maintenance Record
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="maintenanceTable">
                            <thead>
                                <tr>
                                    <th class="sortable">Aircraft</th>
                                    <th class="sortable">Type</th>
                                    <th class="sortable">Description</th>
                                    <th class="sortable">Scheduled Date</th>
                                    <th class="sortable">Expected Finish</th>
                                    <th class="sortable">Status</th>
                                    <th class="sortable">Cost (DT)</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Complete Your Booking</h3>
                <button class="close-modal" onclick="closeBookingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="booking-summary" id="bookingSummary"></div>
                
                <form id="bookingForm">
                    <div class="form-group">
                        <label>Passenger Name *</label>
                        <input type="text" id="passengerName" class="form-input" placeholder="Full name as on ID" required />
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="passengerEmail" class="form-input" placeholder="your@email.com" required onblur="validateEmail(this)" />
                        <span id="emailValidationMessage" style="font-size: 12px; color: #999; margin-top: 5px; display: block;"></span>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div class="phone-input-group">
                            <select id="countryCode" class="country-code-select">
                                <option value="+216">üáπüá≥ +216</option>
                                <option value="+33">üá´üá∑ +33</option>
                                <option value="+44">üá¨üáß +44</option>
                                <option value="+39">üáÆüáπ +39</option>
                                <option value="+34">üá™üá∏ +34</option>
                                <option value="+90">üáπüá∑ +90</option>
                                <option value="+971">üá¶üá™ +971</option>
                                <option value="+20">üá™üá¨ +20</option>
                                <option value="+49">üá©üá™ +49</option>
                                <option value="+1">üá∫üá∏ +1</option>
                            </select>
                            <input type="tel" id="passengerPhone" class="form-input phone-number-input" placeholder="XX XXX XXX" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Confirm Booking</button>
                </form>
                
                <div id="bookingMessage" class="hidden" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Flight Details Modal -->
    <div id="flightDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="flightDetailsTitle">Flight Details</h3>
                <button class="close-modal" onclick="closeFlightDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="flightDetailsBody">
                <!-- Flight details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Maintenance Record Modal -->
    <div id="maintenanceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Maintenance Record</h3>
                <button class="close-modal" onclick="closeMaintenanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <div class="form-group">
                        <label>Aircraft *</label>
                        <select id="maintenanceAircraft" class="form-input" required>
                            <option value="">Select Aircraft</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Maintenance Type *</label>
                        <select id="maintenanceType" class="form-input" required>
                            <option value="routine">Routine</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="unscheduled">Unscheduled</option>
                            <option value="inspection">Inspection</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="maintenanceDescription" class="form-input" rows="3" required placeholder="e.g., Weekly inspection and oil change"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Scheduled Date *</label>
                        <input type="date" id="maintenanceDate" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label>Expected Finish Date *</label>
                        <input type="date" id="maintenanceFinishDate" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label>Technician Name</label>
                        <input type="text" id="maintenanceTechnician" class="form-input" placeholder="Optional" />
                    </div>
                    <div class="form-group">
                        <label>Estimated Cost (DT)</label>
                        <input type="number" id="maintenanceCost" class="form-input" min="0" step="0.01" value="0" />
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Add Record</button>
                        <button type="button" class="btn btn-secondary" onclick="closeMaintenanceModal()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
                <div id="maintenanceMessage" class="hidden" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- Aircraft Details Modal -->
    <div id="aircraftDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="aircraftDetailsTitle">Aircraft Details</h3>
                <button class="close-modal" onclick="closeAircraftDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="aircraftDetailsBody">
                <!-- Aircraft details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Crew Details Modal -->
    <div id="crewDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="crewDetailsTitle">Crew Member Details</h3>
                <button class="close-modal" onclick="closeCrewDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="crewDetailsBody">
                <!-- Crew details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Use same-origin API base when the UI is served by FastAPI (recommended).
        // Falls back to localhost in case the file is opened directly.
        const API_BASE = (window.location && window.location.origin && window.location.origin.startsWith('http'))
            ? `${window.location.origin}/api`
            : 'http://localhost:8000/api';
        let accessToken = null;
        let currentUser = null;
        let selectedFlight = null;
        let searchParams = {};
        let selectedCurrency = 'TND';
        // Base currency is Tunisian Dinar (TND)
        let exchangeRates = { TND: 1 };

        // API Configuration (Add your API keys here)
        const API_KEYS = {
            NUMVERIFY: '0521108a7ec21a7759b5c8972ec9e8f7',  // https://numverify.com/
            OPENSKY: null,  // OpenSky is free, no key needed
            EXCHANGERATE: '23e4e0b15f8960f505e95b4d',  // https://exchangerate-api.com/
            LEAFLET: null  // Leaflet is free for maps
        };

        // Exchange rate conversion
        function convertPrice(priceTND) {
            const rate = exchangeRates[selectedCurrency] || 1;
            return (priceTND * rate).toFixed(2);
        }

        function getCurrencySymbol(currency) {
            const symbols = {
                'TND': 'DT',
                'TND': '$',
                'GBP': '¬£',
                'TND': 'DT',
                'AED': 'ÿØ.ÿ•',
                'TRY': '‚Ç∫'
            };
            return symbols[currency] || currency;
        }

        // Date formatting helpers (DD/MM/YYYY)
        function formatDateDMY(value) {
            if (!value) return '';
            const d = new Date(value);
            if (isNaN(d.getTime())) return String(value);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }
        function formatDateDM(value) {
            if (!value) return '';
            const d = new Date(value);
            if (isNaN(d.getTime())) return String(value);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            return `${dd}/${mm}`;
        }

        // Fetch exchange rates from API
        async function fetchExchangeRates() {
            try {
                // ExchangeRate-API (v6) - base TND
                const key = API_KEYS.EXCHANGERATE;
                const url = key ? `https://v6.exchangerate-api.com/v6/${key}/latest/TND` : 'https://open.er-api.com/v6/latest/TND';
                const response = await fetch(url);
                const data = await response.json();
                
                const rates = data.conversion_rates || data.rates;
                if (rates) {
                    exchangeRates = rates;
                    console.log('‚úì Exchange rates loaded successfully');
                } else {
                    console.log('Using fallback exchange rates');
                    // Fallback rates if API fails
                    exchangeRates = {
                        TND: 1,
                        TND: 0.30,
                        TND: 0.33,
                        GBP: 0.26,
                        AED: 1.22,
                        TRY: 10.90
                    };
                }
            } catch (error) {
                console.error('Failed to fetch exchange rates:', error);
                // Use fallback rates
                exchangeRates = {
                    TND: 1,
                    TND: 0.30,
                    TND: 0.33,
                    GBP: 0.26,
                    AED: 1.22,
                    TRY: 10.90
                };
            }
        }

        // Update currency display
        function updateCurrency() {
            selectedCurrency = document.getElementById('currencySelect')?.value || 'TND';
            // Refresh displayed prices
            if (document.getElementById('flightsGrid').children.length > 0) {
                searchFlights();
            }
        }

        // Country to cities/airports mapping
        const countryCities = {
            'Tunisia': ['Tunis', 'Monastir', 'Djerba', 'Enfidha'],
            'France': ['Paris', 'Lyon', 'Marseille', 'Nice'],
            'United Kingdom': ['London', 'Manchester', 'Birmingham'],
            'Italy': ['Rome', 'Milan', 'Venice', 'Florence'],
            'Spain': ['Madrid', 'Barcelona', 'Valencia'],
            'Turkey': ['Istanbul', 'Ankara', 'Antalya'],
            'UAE': ['Dubai', 'Abu Dhabi'],
            'Egypt': ['Cairo', 'Alexandria', 'Hurghada'],
            'Germany': ['Frankfurt', 'Berlin', 'Munich', 'Hamburg']
        };

        // Update departure cities when country changes
        function updateDepartureCities() {
            const country = document.getElementById('departureCountry').value;
            const cityField = document.getElementById('departureCityField');
            const citySelect = document.getElementById('departureCity');
            
            if (country && countryCities[country]) {
                cityField.style.display = 'block';
                citySelect.innerHTML = '<option value="">Any City</option>';
                countryCities[country].forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            } else {
                cityField.style.display = 'none';
                citySelect.innerHTML = '<option value="">Any City</option>';
            }
        }

        // Update arrival cities when country changes
        function updateArrivalCities() {
            const country = document.getElementById('arrivalCountry').value;
            const cityField = document.getElementById('arrivalCityField');
            const citySelect = document.getElementById('arrivalCity');
            
            if (country && countryCities[country]) {
                cityField.style.display = 'block';
                citySelect.innerHTML = '<option value="">Any City</option>';
                countryCities[country].forEach(city => {
                    citySelect.innerHTML += `<option value="${city}">${city}</option>`;
                });
            } else {
                cityField.style.display = 'none';
                citySelect.innerHTML = '<option value="">Any City</option>';
            }
        }

        // Email domain validation
        async function validateEmail(input) {
            const email = input.value;
            const messageEl = document.getElementById('emailValidationMessage');
            
            if (!email) {
                messageEl.textContent = '';
                return;
            }
            
            const domain = email.split('@')[1];
            if (!domain) {
                messageEl.style.color = '#dc3545';
                messageEl.textContent = '‚ö† Invalid email format';
                return;
            }
            
            messageEl.style.color = '#999';
            messageEl.textContent = '‚è≥ Validating email domain...';
            
            try {
                // Simple DNS check using external API
                const response = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
                const data = await response.json();
                
                if (data.Answer && data.Answer.length > 0) {
                    messageEl.style.color = '#28a745';
                    messageEl.textContent = '‚úì Valid email domain';
                } else {
                    messageEl.style.color = '#ffc107';
                    messageEl.textContent = '‚ö† Email domain may not exist';
                }
            } catch (error) {
                messageEl.style.color = '#999';
                messageEl.textContent = '‚ìò Could not verify domain';
            }
        }

        // Switch admin tabs
        function switchAdminTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
    });

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    if (tab === 'userData') {
        document.getElementById('userDataTab')?.classList.add('active');
        // refresh dashboard data when returning
        if (typeof loadAdminData === 'function') loadAdminData();
    } else if (tab === 'operations') {
        document.getElementById('operationsTab')?.classList.add('active');
        loadOperationsData();
    }
}

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initScrollTopButton();
            initSortableTables();
const today = new Date().toISOString().split('T')[0];
            document.getElementById('flightDate').value = today;
            fetchExchangeRates(); // Load exchange rates on page load
            loadAuthState();
        });

        function loadAuthState() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                accessToken = token;
                currentUser = JSON.parse(user);
                
                if (currentUser.is_admin) {
                    showAdminDashboard();
                } else {
                    showUserPage();
                }
            } else {
                showAuthPage();
            }
        }

        function showAuthPage() {
            const auth = document.getElementById('authPage');
            const user = document.getElementById('userPage');
            const admin = document.getElementById('adminPage');
            
            user.classList.add('hidden');
            admin.classList.add('hidden');
            auth.style.opacity = '0';
            auth.classList.remove('hidden');
            
            setTimeout(() => {
                auth.style.transition = 'opacity 0.5s ease-out';
                auth.style.opacity = '1';
            }, 10);

            // Bind slicers once so filters apply to all graphs
            if (!window.__adminFiltersBound) {
                window.__adminFiltersBound = true;
                ['analyticsStart','analyticsEnd','analyticsGranularity','analyticsDays','analyticsClass','analyticsOrigin','analyticsAircraft'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', () => loadAdminData());
                });
            }
        }

        function showUserPage() {
            const auth = document.getElementById('authPage');
            const user = document.getElementById('userPage');
            const admin = document.getElementById('adminPage');
            
            auth.classList.add('hidden');
            admin.classList.add('hidden');
            user.style.opacity = '0';
            user.classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.full_name;
            
            setTimeout(() => {
                user.style.transition = 'opacity 0.5s ease-out';
                user.style.opacity = '1';
            }, 10);
            
            searchFlights();
            
            // Initialize enhanced features
            fetchExchangeRates();
            setupPhoneValidation();
            setTimeout(initializeMap, 1500);
        }

        function showAdminDashboard() {
            const auth = document.getElementById('authPage');
            const user = document.getElementById('userPage');
            const admin = document.getElementById('adminPage');
            
            auth.classList.add('hidden');
            user.classList.add('hidden');
            admin.style.opacity = '0';
            admin.classList.remove('hidden');
            
            document.getElementById('adminName').textContent = currentUser.full_name;
            
            setTimeout(() => {
                admin.style.transition = 'opacity 0.5s ease-out';
                admin.style.opacity = '1';
            }, 10);

                        // Set default date range (last 30 days) if empty
            try {
                const s = document.getElementById('analyticsStart');
                const e = document.getElementById('analyticsEnd');
                if (s && e && (!s.value || !e.value)) {
                    const end = new Date();
                    const start = new Date();
                    start.setDate(end.getDate() - 30);
                    s.value = start.toISOString().slice(0,10);
                    e.value = end.toISOString().slice(0,10);
                }
            } catch(_) {}

            loadAdminData();
        }

        function switchTab(tab) {
    // Activate correct tab button
    document.querySelectorAll('.tab').forEach(btn => {
        const btnTab = btn.getAttribute('data-tab') || btn.textContent.trim().toLowerCase();
        btn.classList.toggle('active', btnTab === tab);
    });

    // Toggle forms
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    if (tab === 'login') {
        loginForm?.classList.remove('hidden');
        registerForm?.classList.add('hidden');
    } else {
        registerForm?.classList.remove('hidden');
        loginForm?.classList.add('hidden');
    }

    // Clear any messages when switching tabs
    const msg = document.getElementById('authMessage');
    if (msg) msg.classList.add('hidden');
}

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) throw new Error('Invalid credentials');
                
                const data = await response.json();
                accessToken = data.access_token;
                currentUser = data.user;
                
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                if (currentUser.is_admin) {
                    showAdminDashboard();
                } else {
                    showUserPage();
                }
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        });

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                phone_number: document.getElementById('regPhone').value || null,
                full_name: document.getElementById('regFullName').value,
                password: document.getElementById('regPassword').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(userData)
});

const payload = await response.json().catch(() => ({}));
if (!response.ok) {
    // FastAPI can return detail as string or list of validation errors
    const d = payload?.detail ?? payload;
    let msg = 'Registration failed';
    if (Array.isArray(d)) {
        msg = d.map(x => x?.msg || x?.message || JSON.stringify(x)).join(' | ');
    } else if (typeof d === 'object' && d) {
        msg = d.msg || d.message || JSON.stringify(d);
    } else if (d) {
        msg = String(d);
    }
    throw new Error(msg);
}

// Auto-login after successful registration
accessToken = payload.access_token;
localStorage.setItem('access_token', accessToken);
localStorage.setItem('refresh_token', payload.refresh_token || '');

// Load user profile and redirect to user website
const meRes = await fetch(`${API_BASE}/auth/me`, {
    headers: { 'Authorization': `Bearer ${accessToken}` }
});
const me = await meRes.json().catch(() => null);
if (!meRes.ok || !me) {
    showMessage('authMessage', 'Registration successful. Please login.', 'success');
    switchTab('login');
} else {
    currentUser = me;
    showMessage('authMessage', '‚úÖ Registration successful. Redirecting...', 'success');
    showUserPage();
}

document.getElementById('registerForm').reset();
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        });

        function logout() {
            localStorage.clear();
            accessToken = null;
            currentUser = null;
            showAuthPage();
        }

        // Calculate price
        function calculatePrice(ticketClass, numPassengers, flightBasePrice = 150) {
            const basePrice = flightBasePrice || 150;
            const multipliers = {
                'economy': 1.0,
                'premium': 1.5,
                'business': 2.5
            };
            return basePrice * multipliers[ticketClass] * numPassengers;
        }

        // Search Flights
        async function searchFlights() {
            const departureCountry = document.getElementById('departureCountry').value;
            const departureCity = document.getElementById('departureCity').value;
            const arrivalCountry = document.getElementById('arrivalCountry').value;
            const arrivalCity = document.getElementById('arrivalCity').value;
            const date = document.getElementById('flightDate').value;
            const numPassengers = parseInt(document.getElementById('numPassengers').value);
            const ticketClass = document.getElementById('ticketClass').value;
            
            // Use city if selected, otherwise use any city from country
            const departure = departureCity || (departureCountry ? null : '');
            const arrival = arrivalCity || (arrivalCountry ? null : '');
            
            searchParams = { departure, arrival, date, numPassengers, ticketClass, departureCountry, arrivalCountry };
            
            try {
                const response = await fetch(`${API_BASE}/flights?date=${date}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Unable to load flights');
                }
                let flights = Array.isArray(data.items) ? data.items : [];
                
                // Filter by city if specified
                if (departure) {
                    flights = flights.filter(f => f.origin === departure);
                } else if (departureCountry && countryCities[departureCountry]) {
                    // Filter by any city in the country
                    const cities = countryCities[departureCountry];
                    flights = flights.filter(f => cities.includes(f.origin));
                }
                
                if (arrival) {
                    flights = flights.filter(f => f.destination === arrival);
                } else if (arrivalCountry && countryCities[arrivalCountry]) {
                    // Filter by any city in the country
                    const cities = countryCities[arrivalCountry];
                    flights = flights.filter(f => cities.includes(f.destination));
                }
                
                displayFlights(flights);
            } catch (error) {
                console.error('Error loading flights:', error);
            }
        }

        function displayFlights(flights) {
            const container = document.getElementById('flightsGrid');
            const resultsCount = document.getElementById('resultsCount');
            
            container.innerHTML = '';
            resultsCount.textContent = `${flights.length} flights found`;
            
            if (flights.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <h3>No flights found</h3>
                        <p>Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }
            
            flights.forEach((flight, index) => {
                const depTime = new Date(flight.scheduled_departure);
                const arrTime = new Date(flight.scheduled_arrival);
                const flightBasePrice = flight.base_price || 150;
                const price = calculatePrice(searchParams.ticketClass, searchParams.numPassengers, flightBasePrice);
                
                const card = document.createElement('div');
                card.className = 'flight-card';
                card.style.animationDelay = `${index * 0.1}s`;
                card.style.opacity = '0';
                card.style.cursor = 'pointer';
                card.style.transition = 'all 0.3s ease';
                
                // Add click-to-view-details (excluding the book button)
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.btn-book')) {
                        showFlightDetails(flight);
                    }
                });
                
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-8px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.transform = '';
                });
                
                card.innerHTML = `
                    <div class="flight-header">
                        <div class="flight-number">${flight.flight_number}</div>
                        <div class="flight-status status-${flight.status}">${flight.status}</div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-size: 14px; color: #666; font-weight: 600;">
                            üìÖ ${formatDateDMY(depTime)}
                        </div>
                    </div>
                    <div class="flight-route">
                        <div class="city">
                            <div class="city-name">${flight.origin}</div>
                            <div class="city-time">${depTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="route-arrow">‚Üí</div>
                        <div class="city">
                            <div class="city-name">${flight.destination}</div>
                            <div class="city-time">${arrTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                    <div class="flight-details">
                        <div class="detail-item">
                            <div class="detail-label">Gate</div>
                            <div class="detail-value">${flight.gate || 'TBA'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${calculateDuration(depTime, arrTime)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Seats Left</div>
                            <div class="detail-value">${200 - flight.passengers_booked}</div>
                        </div>
                    </div>
                    <div class="flight-footer">
                        <div class="price-section">
                            <div class="price-label">Price (${searchParams.numPassengers} pax)</div>
                            <div class="price">${getCurrencySymbol(selectedCurrency)}${convertPrice(price)}</div>
                        </div>
                        <button class="btn-book" onclick='openBookingModal(${JSON.stringify(flight)}, ${price})'>
                            Book Now
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: #999; font-size: 12px;">
                        üí° Click card for full details
                    </div>
                `;
                container.appendChild(card);
                
                // Trigger animation
                setTimeout(() => {
                    card.style.animation = 'slideUp 0.5s ease-out forwards';
                    card.style.opacity = '1';
                }, index * 50);
            });
        }

        function calculateDuration(dep, arr) {
            const diff = arr - dep;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}m`;
        }

        function clearSearch() {
            document.getElementById('departureCountry').value = '';
            document.getElementById('arrivalCountry').value = '';
            document.getElementById('departureCity').value = '';
            document.getElementById('arrivalCity').value = '';
            document.getElementById('departureCityField').style.display = 'none';
            document.getElementById('arrivalCityField').style.display = 'none';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('flightDate').value = today;
            document.getElementById('numPassengers').value = '1';
            document.getElementById('ticketClass').value = 'economy';
            searchFlights();
        }

        // Show All Upcoming Flights
        async function showAllFlights() {
            // Clear all filters
            document.getElementById('departureCountry').value = '';
            document.getElementById('arrivalCountry').value = '';
            document.getElementById('departureCity').value = '';
            document.getElementById('arrivalCity').value = '';
            document.getElementById('departureCityField').style.display = 'none';
            document.getElementById('arrivalCityField').style.display = 'none';
            document.getElementById('flightDate').value = ''; // Clear date to show all
            
            const numPassengers = parseInt(document.getElementById('numPassengers').value);
            const ticketClass = document.getElementById('ticketClass').value;
            
            searchParams = { numPassengers, ticketClass };
            
            try {
                const response = await fetch(`${API_BASE}/flights`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                
                // Filter only upcoming flights (from today onwards)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const upcomingFlights = data.items.filter(flight => {
                    const flightDate = new Date(flight.scheduled_departure);
                    return flightDate >= today;
                });
                
                // Sort by date
                upcomingFlights.sort((a, b) => 
                    new Date(a.scheduled_departure) - new Date(b.scheduled_departure)
                );
                
                displayFlights(upcomingFlights);
            } catch (error) {
                console.error('Error fetching all flights:', error);
            }
        }

        // Booking Modal
        function openBookingModal(flight, price) {
            selectedFlight = flight;
            
            const summary = `
                <div class="summary-row">
                    <span class="summary-label">Flight</span>
                    <span class="summary-value">${flight.flight_number}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Route</span>
                    <span class="summary-value">${flight.origin} ‚Üí ${flight.destination}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Date</span>
                    <span class="summary-value">${formatDateDMY(flight.scheduled_departure)}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Passengers</span>
                    <span class="summary-value">${searchParams.numPassengers}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Class</span>
                    <span class="summary-value">${searchParams.ticketClass.charAt(0).toUpperCase() + searchParams.ticketClass.slice(1)}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total</span>
                    <span class="total-price">${getCurrencySymbol(selectedCurrency)}${convertPrice(price)}</span>
                </div>
            `;
            
            document.getElementById('bookingSummary').innerHTML = summary;
            document.getElementById('bookingModal').style.display = 'block';
            document.getElementById('bookingMessage').classList.add('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('bookingForm').reset();
        }


// ============================================================================
// PHONE VALIDATION WITH NUMVERIFY API
// ============================================================================

async function validatePhoneNumber(phoneNumber, countryCode) {
    const validationDiv = document.getElementById('phoneValidation') || createPhoneValidationDiv();
    
    if (!phoneNumber || !API_KEYS.NUMVERIFY || API_KEYS.NUMVERIFY === '0521108a7ec21a7759b5c8972ec9e8f7') {
        validationDiv.style.display = 'none';
        return true;
    }
    
    validationDiv.className = 'phone-validation checking';
    validationDiv.textContent = '‚è≥ Validating...';
    validationDiv.style.display = 'block';
    
    try {
        const cleanCode = countryCode.replace('+', '');
        const fullNumber = cleanCode + phoneNumber.replace(/\s/g, '');
        
        const response = await fetch(
            `http://apilayer.net/api/validate?access_key=${API_KEYS.NUMVERIFY}&number=${fullNumber}`
        );
        const data = await response.json();
        
        if (data.valid) {
            validationDiv.className = 'phone-validation valid';
            validationDiv.textContent = `‚úì Valid ${data.country_name} number`;
            return true;
        } else {
            validationDiv.className = 'phone-validation invalid';
            validationDiv.textContent = '‚ö† Invalid phone number';
            return false;
        }
    } catch (error) {
        console.error('Phone validation error:', error);
        validationDiv.style.display = 'none';
        return true;
    }
}

function createPhoneValidationDiv() {
    const div = document.createElement('div');
    div.id = 'phoneValidation';
    div.className = 'phone-validation';
    document.getElementById('passengerPhone').parentElement.appendChild(div);
    return div;
}

function setupPhoneValidation() {
    const phoneInput = document.getElementById('passengerPhone');
    if (phoneInput) {
        phoneInput.addEventListener('blur', () => {
            const countryCode = document.getElementById('countryCode').value;
            validatePhoneNumber(phoneInput.value, countryCode);
        });
    }
}

// ============================================================================
// FLIGHT DETAILS MODAL
// ============================================================================

function showFlightDetails(flight) {
    const modal = document.getElementById('flightDetailsModal');
    const body = document.getElementById('flightDetailsBody');
    const depTime = new Date(flight.scheduled_departure);
    const arrTime = new Date(flight.scheduled_arrival);
    
    const duration = Math.round((arrTime - depTime) / (1000 * 60));
    const hours = Math.floor(duration / 60);
    const minutes = duration % 60;
    
    body.innerHTML = `
        <div class="detail-panel">
            <div class="detail-row">
                <div class="detail-box">
                    <div class="detail-box-label">Flight Number</div>
                    <div class="detail-box-value">${flight.flight_number}</div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">Aircraft</div>
                    <div class="detail-box-value">${flight.aircraft_id}</div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">Status</div>
                    <div class="detail-box-value"><span class="flight-status status-${flight.status}">${flight.status}</span></div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-box">
                    <div class="detail-box-label">üõ´ Departure</div>
                    <div class="detail-box-value">${flight.origin}</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        ${formatDateDMY(depTime)} at ${depTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">üõ¨ Arrival</div>
                    <div class="detail-box-value">${flight.destination}</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        ${formatDateDMY(arrTime)} at ${arrTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-box">
                    <div class="detail-box-label">Gate</div>
                    <div class="detail-box-value">${flight.gate || 'TBA'}</div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">Duration</div>
                    <div class="detail-box-value">${hours}h ${minutes}m</div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">Delay</div>
                    <div class="detail-box-value">${flight.delay_minutes || 0} min</div>
                </div>
                <div class="detail-box">
                    <div class="detail-box-label">Seats Available</div>
                    <div class="detail-box-value">${200 - (flight.passengers_booked || 0)} / 200</div>
                </div>
            </div>
        </div>
    `;
    modal.style.display = 'block';
}

function closeFlightDetailsModal() {
    document.getElementById('flightDetailsModal').style.display = 'none';
}

// ============================================================================
// MAINTENANCE MODAL
// ============================================================================

function openMaintenanceModal() {
    document.getElementById('maintenanceModal').style.display = 'block';
    loadAircraftForMaintenance();
}

function closeMaintenanceModal() {
    document.getElementById('maintenanceModal').style.display = 'none';
    document.getElementById('maintenanceForm').reset();
    document.getElementById('maintenanceMessage').classList.add('hidden');
}

async function loadAircraftForMaintenance() {
    const select = document.getElementById('maintenanceAircraft');
    try {
        const response = await fetch(`${API_BASE}/aircraft`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        select.innerHTML = '<option value="">Select Aircraft</option>';
        data.items.forEach(aircraft => {
            select.innerHTML += `<option value="${aircraft.id}">${aircraft.registration} - ${aircraft.model}</option>`;
        });
    } catch (error) {
        console.error('Error loading aircraft:', error);
    }
}

// ============================================================================
// AIRCRAFT & CREW DETAILS MODALS
// ============================================================================

async function showAircraftDetailsModal(registration) {
    const modal = document.getElementById('aircraftDetailsModal');
    const body = document.getElementById('aircraftDetailsBody');
    
    try {
        const response = await fetch(`${API_BASE}/aircraft`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        const aircraft = data.items.find(a => a.registration === registration);
        
        if (!aircraft) {
            body.innerHTML = '<p>Aircraft not found</p>';
            modal.style.display = 'block';
            return;
        }
        
        body.innerHTML = `
            <img src="Fleet/${registration}.jpg" alt="${registration}" class="aircraft-image" 
                 onerror="this.outerHTML='<div class=\'aircraft-image-placeholder\'>üì∑ ${registration}</div>'" />
            <div class="detail-panel">
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">Registration</div>
                        <div class="detail-box-value">${aircraft.registration}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Model</div>
                        <div class="detail-box-value">${aircraft.model}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Manufacturer</div>
                        <div class="detail-box-value">${aircraft.manufacturer}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">Total Seats</div>
                        <div class="detail-box-value">${aircraft.total_seats}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Status</div>
                        <div class="detail-box-value"><span class="flight-status status-${aircraft.status}">${aircraft.status}</span></div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Flight Hours</div>
                        <div class="detail-box-value">${aircraft.total_flight_hours.toFixed(0)}h</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">Current Location</div>
                        <div class="detail-box-value">${aircraft.current_location || 'N/A'}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Last Maintenance</div>
                        <div class="detail-box-value">${aircraft.last_maintenance_date ? formatDateDMY(aircraft.last_maintenance_date) : 'N/A'}</div>
                    </div>
                </div>
            </div>
        `;
        modal.style.display = 'block';
    } catch (error) {
        console.error('Error loading aircraft details:', error);
        body.innerHTML = '<p>Error loading aircraft details</p>';
        modal.style.display = 'block';
    }
}

function closeAircraftDetailsModal() {
    document.getElementById('aircraftDetailsModal').style.display = 'none';
}

async function showCrewDetailsModal(crewId) {
    const modal = document.getElementById('crewDetailsModal');
    const body = document.getElementById('crewDetailsBody');
    
    try {
        const response = await fetch(`${API_BASE}/crew`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await response.json();
        const crew = data.items.find(c => c.id === crewId);
        
        if (!crew) {
            body.innerHTML = '<p>Crew member not found</p>';
            modal.style.display = 'block';
            return;
        }
        
        body.innerHTML = `
            <div class="detail-panel">
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">Employee ID</div>
                        <div class="detail-box-value">${crew.employee_id}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Full Name</div>
                        <div class="detail-box-value">${crew.full_name}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Role</div>
                        <div class="detail-box-value">${crew.role}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">License Number</div>
                        <div class="detail-box-value">${crew.license_number || 'N/A'}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Flight Hours</div>
                        <div class="detail-box-value">${crew.total_flight_hours.toFixed(0)}h</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-box-label">Status</div>
                        <div class="detail-box-value"><span class="flight-status status-${crew.status}">${crew.status}</span></div>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-box">
                        <div class="detail-box-label">Base Location</div>
                        <div class="detail-box-value">${crew.base_location}</div>
                    </div>
                </div>
            </div>
        `;
        modal.style.display = 'block';
    } catch (error) {
        console.error('Error loading crew details:', error);
        body.innerHTML = '<p>Error loading crew details</p>';
        modal.style.display = 'block';
    }
}

function closeCrewDetailsModal() {
    document.getElementById('crewDetailsModal').style.display = 'none';
}

// ============================================================================
// OPENSKY API & MAP
// ============================================================================

// ------------------------------
// LEAFLET MAP (SCHEDULED + LIVE)
// ------------------------------

let routeMapInstance = null;
let scheduledRoutesLayer = null;
let liveRoutesLayer = null;
let liveMarkersLayer = null;

// City coordinates used for route lines (kept simple & local to avoid extra geocoding APIs)
const cityCoords = {
    'Tunis': [36.8510, 10.2272],
    'Monastir': [35.7643, 10.7547],
    'Djerba': [33.8750, 10.7755],
    'Enfidha': [36.0758, 10.4386],
    'Sfax': [34.7398, 10.7600],
    'Paris': [48.8566, 2.3522],
    'Nice': [43.7102, 7.2620],
    'Marseille': [43.2965, 5.3698],
    'Lyon': [45.7640, 4.8357],
    'London': [51.5074, -0.1278],
    'Rome': [41.9028, 12.4964],
    'Milan': [45.4642, 9.1900],
    'Madrid': [40.4168, -3.7038],
    'Barcelona': [41.3851, 2.1734],
    'Istanbul': [41.0082, 28.9784],
    'Dubai': [25.2048, 55.2708],
    'Doha': [25.2854, 51.5310],
    'Cairo': [30.0444, 31.2357],
    'Jeddah': [21.4858, 39.1925],
    'Casablanca': [33.5731, -7.5898],
    'Algiers': [36.7538, 3.0588],
    'Tripoli': [32.8872, 13.1913],
    'Vienna': [48.2082, 16.3738],
    'Zurich': [47.3769, 8.5417],
    'Geneva': [46.2044, 6.1432],
    'Brussels': [50.8476, 4.3572],
    'Amsterdam': [52.3676, 4.9041],
    'Frankfurt': [50.1109, 8.6821],
    'Munich': [48.1351, 11.5820],
    'Lisbon': [38.7223, -9.1393],
    'Copenhagen': [55.6761, 12.5683],
    'Athens': [37.9838, 23.7275],
    'Prague': [50.0755, 14.4378]
};

const tunisianHubs = ['Tunis', 'Monastir', 'Djerba', 'Enfidha'];

async function fetchLiveFlights() {
    try {
        // Use backend proxy to avoid browser CORS blocks on OpenSky
        const response = await fetch(`${API_BASE}/live-flights`);
        const data = await response.json();
        return data.items || [];
    } catch (error) {
        console.error('Live flights fetch error:', error);
        return [];
    }
}

function buildCurvedArc(a, b) {
    // Quadratic-like curve sampled into points for Leaflet polyline.
    // a, b are [lat, lng]
    const lat1 = a[0], lng1 = a[1];
    const lat2 = b[0], lng2 = b[1];

    // Midpoint
    const midLat = (lat1 + lat2) / 2;
    const midLng = (lng1 + lng2) / 2;

    // Perpendicular offset to create curvature
    const dx = lng2 - lng1;
    const dy = lat2 - lat1;
    const dist = Math.sqrt(dx*dx + dy*dy) || 1;

    // Curvature factor (scale with distance, clamped)
    const k = Math.min(0.8, Math.max(0.18, dist / 18));
    const offLat = -dx / dist * k;
    const offLng = dy / dist * k;

    const ctrl = [midLat + offLat, midLng + offLng];

    // Sample quadratic Bezier
    const pts = [];
    const steps = 24;
    for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const lat = (1-t)*(1-t)*lat1 + 2*(1-t)*t*ctrl[0] + t*t*lat2;
        const lng = (1-t)*(1-t)*lng1 + 2*(1-t)*t*ctrl[1] + t*t*lng2;
        pts.push([lat, lng]);
    }
    return pts;
}

function isSameLocalDate(a, b) {
    return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
}

function startMapClock() {
    const el = document.getElementById('mapClock');
    if (!el) return;
    function tick() {
        const now = new Date();
        el.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
    tick();
    setInterval(tick, 1000);
}

function initializeMap() {
    if (typeof L === 'undefined' || !document.getElementById('routeMap')) return;
    if (routeMapInstance) return;

    try {
        routeMapInstance = L.map('routeMap', { zoomControl: true }).setView([36.8065, 10.1815], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 18
        }).addTo(routeMapInstance);

        scheduledRoutesLayer = L.layerGroup().addTo(routeMapInstance);
        liveRoutesLayer = L.layerGroup().addTo(routeMapInstance);
        startMapClock();
        liveMarkersLayer = L.layerGroup().addTo(routeMapInstance);

        // Mark Tunisia hubs
        tunisianHubs.forEach(city => {
            const c = cityCoords[city];
            if (!c) return;
            const m = L.marker(c).addTo(routeMapInstance);
            m.bindPopup(`<b>${city}</b><br/>Tunisair hub airport`);
        });

        // Default map date = selected search date or today
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        const flightDate = document.getElementById('flightDate')?.value;
        document.getElementById('mapDateFilter').value = flightDate || iso;

        console.log('‚úì Route map initialized');
        refreshRouteMap(true);
    } catch (error) {
        console.error('Map initialization error:', error);
    }
}

function shiftMapDate(deltaDays) {
    const input = document.getElementById('mapDateFilter');
    if (!input?.value) return;
    const d = new Date(input.value);
    d.setDate(d.getDate() + deltaDays);
    input.value = d.toISOString().slice(0, 10);
    refreshRouteMap(true);
}

async function refreshRouteMap(includeLive = false) {
    if (!routeMapInstance) return;
    const dateValue = document.getElementById('mapDateFilter')?.value;
    const statusEl = document.getElementById('mapStatus');
    const showScheduled = document.getElementById('mapShowScheduled')?.checked ?? true;
    const showLive = document.getElementById('mapShowLive')?.checked ?? true;
    if (statusEl) statusEl.textContent = 'Loading routes...';

    scheduledRoutesLayer.clearLayers();
    liveRoutesLayer.clearLayers();
    liveMarkersLayer.clearLayers();

    // Scheduled routes for selected day
    if (showScheduled) {
        try {
            const res = await fetch(`${API_BASE}/flights?date=${encodeURIComponent(dateValue || '')}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await res.json();
            // One-way scheduled flights: only flights DEPARTING from Tunisian hubs.
            const flights = (data.items || []).filter(f => tunisianHubs.includes(f.origin));

            let drawn = 0;
            flights.forEach(f => {
                const a = cityCoords[f.origin];
                const b = cityCoords[f.destination];
                if (!a || !b) return;

                const arcPts = buildCurvedArc(a, b);
                const line = L.polyline(arcPts, {
                    weight: 2.5,
                    opacity: 0.85,
                    color: '#d71920',
                    lineCap: 'round'
                });
                line.addTo(scheduledRoutesLayer);

                const tooltipHtml = `
                    <div style="font-size:12px;">
                        <b>${f.flight_number}</b><br/>
                        ${f.origin} ‚Üí ${f.destination}<br/>
                        Dep: ${new Date(f.scheduled_departure).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br/>
                        Arr: ${new Date(f.scheduled_arrival).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br/>
                        Seats left: ${Math.max(0, (f.available_seats ?? 200) - (f.passengers_booked ?? 0))}
                    </div>
                `;

                line.bindTooltip(tooltipHtml, { sticky: true });
                drawn += 1;
            });

            if (statusEl) statusEl.textContent = `Scheduled routes: ${drawn}`;
        } catch (e) {
            console.error('Scheduled routes error:', e);
            if (statusEl) statusEl.textContent = 'Failed to load scheduled routes';
        }
    } else {
        if (statusEl) statusEl.textContent = 'Scheduled routes: hidden';
    }

    // Live flights (only if selected date is TODAY)
    if (includeLive && showLive) {
        try {
            let liveDrawn = 0;
        const selectedDateObj = dateValue ? new Date(dateValue + 'T00:00:00') : new Date();
        const todayObj = new Date();
        if (isSameLocalDate(selectedDateObj, todayObj)) {
            const live = await fetchLiveFlights();
            live.forEach(l => {
                const pos = [l.latitude, l.longitude];
                const hub = cityCoords['Tunis'];
                    const line = L.polyline(buildCurvedArc(hub, pos), { weight: 1.8, opacity: 0.7, dashArray: '7,7', color: '#991b1b', lineCap: 'round' });
                line.addTo(liveRoutesLayer);

                const m = L.circleMarker(pos, { radius: 4, weight: 1, opacity: 0.9, fillOpacity: 0.7 });
                m.addTo(liveMarkersLayer);

                const info = `
                    <div style="font-size:12px;">
                        <b>Live: ${l.callsign}</b><br/>
                        Alt: ${l.altitude ? Math.round(l.altitude) + ' m' : 'N/A'}<br/>
                        Speed: ${l.velocity ? Math.round(l.velocity) + ' m/s' : 'N/A'}
                    </div>
                `;

                line.bindTooltip(info, { sticky: true });
                m.bindTooltip(info, { sticky: true });
                liveDrawn += 1;
            });
            }
            if (statusEl) statusEl.textContent += ` ‚Ä¢ Live flights: ${liveDrawn}`;
        } catch (e) {
            console.error('Live routes error:', e);
        }
    }
}

        
        // Book Flight
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const countryCode = document.getElementById('countryCode').value;
            const phoneNumber = document.getElementById('passengerPhone').value;
            const fullPhone = phoneNumber ? `${countryCode} ${phoneNumber}` : '';
            
            const bookingData = {
                flight_id: selectedFlight.id,
                passenger_name: document.getElementById('passengerName').value,
                passenger_email: document.getElementById('passengerEmail').value,
                passenger_phone: fullPhone,
                departure_place: selectedFlight.origin,
                arrival_place: selectedFlight.destination,
                num_passengers: searchParams.numPassengers,
                ticket_class: searchParams.ticketClass
            };
            
            try {
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                
                if (!response.ok) {
    const errorData = await response.json().catch(() => ({ detail: 'Booking failed' }));
    const d = errorData?.detail ?? errorData;
    let msg = 'Booking failed';
    if (Array.isArray(d)) {
        msg = d.map(x => x?.msg || x?.message || JSON.stringify(x)).join(' | ');
    } else if (typeof d === 'object' && d) {
        msg = d.msg || d.message || JSON.stringify(d);
    } else if (d) {
        msg = String(d);
    }
    throw new Error(msg);
}
                
                const result = await response.json();
                showMessage('bookingMessage', `‚úÖ Booking confirmed! Reference: ${result.booking_reference}`, 'success');
                document.getElementById('bookingForm').reset();
                
                setTimeout(() => {
                    closeBookingModal();
                    showMyBookings();
                }, 2000);
            } catch (error) {
                console.error('Booking error:', error);
                showMessage('bookingMessage', `‚ùå ${error.message}`, 'error');
            }
        });

        // Maintenance Form Handler
        document.getElementById('maintenanceForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maintenanceData = {
                aircraft_id: parseInt(document.getElementById('maintenanceAircraft').value),
                maintenance_type: document.getElementById('maintenanceType').value,
                description: document.getElementById('maintenanceDescription').value,
                scheduled_date: document.getElementById('maintenanceDate').value,
                expected_finish_date: document.getElementById('maintenanceFinishDate').value,
                technician_name: document.getElementById('maintenanceTechnician').value || null,
                cost: parseFloat(document.getElementById('maintenanceCost').value) || 0
            };
            
            try {
                const response = await fetch(`${API_BASE}/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(maintenanceData)
                });
                
                if (!response.ok) throw new Error('Failed to add maintenance record');
                
                const msgEl = document.getElementById('maintenanceMessage');
                msgEl.textContent = '‚úì Maintenance record added successfully!';
                msgEl.style.background = '#d4edda';
                msgEl.style.color = '#155724';
                msgEl.style.padding = '12px';
                msgEl.style.borderRadius = '8px';
                msgEl.classList.remove('hidden');
                
                document.getElementById('maintenanceForm').reset();
                
                setTimeout(() => {
                    closeMaintenanceModal();
                    loadOperationsData();
                }, 1500);
            } catch (error) {
                const msgEl = document.getElementById('maintenanceMessage');
                msgEl.textContent = '‚ö† Error: ' + error.message;
                msgEl.style.background = '#f8d7da';
                msgEl.style.color = '#721c24';
                msgEl.style.padding = '12px';
                msgEl.style.borderRadius = '8px';
                msgEl.classList.remove('hidden');
            }
        });

        // My Bookings
        function showMyBookings() {
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('flightsSection').classList.add('hidden');
            document.getElementById('bookingsSection').classList.remove('hidden');
            loadMyBookings();
        }

        function showSearchSection() {
            document.getElementById('searchSection').classList.remove('hidden');
            document.getElementById('flightsSection').classList.remove('hidden');
            document.getElementById('bookingsSection').classList.add('hidden');
            searchFlights();
        }

        async function loadMyBookings() {
            try {
                const response = await fetch(`${API_BASE}/bookings/my`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                
                const container = document.getElementById('bookingsGrid');
                container.innerHTML = '';
                
                if (data.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No bookings yet</h3>
                            <p>Start by searching and booking a flight</p>
                        </div>
                    `;
                    return;
                }
                
                data.items.forEach(booking => {
                    const card = document.createElement('div');
                    card.className = 'booking-card';
                    const depTime = new Date(booking.flight.scheduled_departure);
                    
                    card.innerHTML = `
                        <div class="booking-header">
                            <div>
                                <div class="booking-ref">${booking.booking_reference}</div>
                                <div class="booking-date">Booked on ${formatDateDMY(booking.created_at)}</div>
                            </div>
                            <div class="flight-status status-${booking.status}">${booking.status}</div>
                        </div>
                        <div class="booking-details">
                            <div class="detail-item">
                                <div class="detail-label">Flight</div>
                                <div class="detail-value">${booking.flight.flight_number}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Route</div>
                                <div class="detail-value">${booking.departure_place} ‚Üí ${booking.arrival_place}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Date</div>
                                <div class="detail-value">${formatDateDMY(depTime)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Time</div>
                                <div class="detail-value">${depTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Passengers</div>
                                <div class="detail-value">${booking.num_passengers}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Class</div>
                                <div class="detail-value">${booking.ticket_class.charAt(0).toUpperCase() + booking.ticket_class.slice(1)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Passenger</div>
                                <div class="detail-value">${booking.passenger_name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Price</div>
                                <div class="detail-value">DT${booking.price.toFixed(2)}</div>
                            </div>
                        </div>
                        ${booking.status === 'confirmed' ? `
                            <div class="booking-actions">
                                <button class="btn btn-danger" onclick="cancelBooking(${booking.id})">Cancel Booking</button>
                            </div>
                        ` : ''}
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to cancel booking');
                
                loadMyBookings();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone!')) return;
            if (!confirm('All your bookings will be cancelled. Are you absolutely sure?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete account');
                
                alert('Account deleted successfully');
                logout();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Admin Functions
        async function loadAdminData() {
            try {
                // Ensure datalabels plugin is registered (for percentages on pie/doughnut)
                if (window.Chart && window.ChartDataLabels) {
                    try { Chart.register(ChartDataLabels); } catch (_) {}
                }

                // Read slicers (safe defaults)
                const startDate = document.getElementById('analyticsStart')?.value || '';
                const endDate = document.getElementById('analyticsEnd')?.value || '';
                const days = document.getElementById('analyticsDays')?.value || '30';
                const cls = document.getElementById('analyticsClass')?.value || '';
                const origin = document.getElementById('analyticsOrigin')?.value || '';
                const aircraftReg = document.getElementById('analyticsAircraft')?.value || '';

                const params = {
                    ...(startDate && endDate ? { start_date: startDate, end_date: endDate } : { days }),
                    ...(cls ? { ticket_class: cls } : {}),
                    ...(origin ? { origin } : {}),
                    ...(aircraftReg ? { aircraft_registration: aircraftReg } : {})
                };
                const qs = new URLSearchParams(params).toString();

                const [kpis, aircraftList, crewList, maintenanceList, bookingsOverTime, popularRoutes, bookingsByClass, userGrowth, passengersPerDay, bookingsByStatus, topCustomers] = await Promise.all([
                    fetch(`${API_BASE}/admin/kpis`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/aircraft`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/crew`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/maintenance`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/bookings-over-time?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/popular-routes?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/bookings-by-class?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/user-growth?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/passengers-per-day?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/bookings-by-status?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json()),
                    fetch(`${API_BASE}/admin/analytics/top-customers?${qs}`, { headers: { 'Authorization': `Bearer ${accessToken}` }}).then(r => r.json())
                ]);

                // Populate aircraft slicer once (or preserve selection)
                try {
                    const sel = document.getElementById('analyticsAircraft');
                    if (sel && aircraftList?.items) {
                        const current = sel.value;
                        const options = ['<option value="">All</option>']
                            .concat(aircraftList.items.map(a => `<option value="${a.registration}">${a.registration}</option>`));
                        sel.innerHTML = options.join('');
                        if (current) sel.value = current;
                    }
                } catch (_) {}
                
                // Update KPIs
                document.getElementById('totalUsers').textContent = kpis.total_users || 0;
                document.getElementById('totalBookings').textContent = kpis.total_bookings || 0;
                document.getElementById('totalRevenue').textContent = `DT${(kpis.total_revenue || 0).toLocaleString()}`;
                document.getElementById('avgBookingValue').textContent = `DT${(kpis.avg_booking_value || 0).toFixed(0)}`;
                document.getElementById('totalPassengers').textContent = kpis.total_passengers || 0;
                document.getElementById('totalFlights').textContent = kpis.total_flights || 0;
                document.getElementById('totalAircraft').textContent = `${kpis.operational_aircraft || 0}/${kpis.total_aircraft || 0}`;
                document.getElementById('occupancyRate').textContent = `${(kpis.occupancy_rate || 0).toFixed(1)}%`;

                // Cache analytics for client-side sorting & consistent re-rendering
                adminAnalyticsCache.bookingsOverTime = Array.isArray(bookingsOverTime) ? bookingsOverTime : [];
                adminAnalyticsCache.popularRoutes = Array.isArray(popularRoutes) ? popularRoutes : [];
                adminAnalyticsCache.bookingsByClass = Array.isArray(bookingsByClass) ? bookingsByClass : [];
                adminAnalyticsCache.userGrowth = Array.isArray(userGrowth) ? userGrowth : [];
                adminAnalyticsCache.passengersPerDay = Array.isArray(passengersPerDay) ? passengersPerDay : [];
                adminAnalyticsCache.bookingsByStatus = Array.isArray(bookingsByStatus) ? bookingsByStatus : [];
                adminAnalyticsCache.topCustomers = Array.isArray(topCustomers) ? topCustomers : [];

                // Internal summaries (for Dashboards tab)
                const maintItems = Array.isArray(maintenanceList?.items) ? maintenanceList.items : [];
                const maintCounts = {};
                maintItems.forEach(m => {
                    const t = (m?.maintenance_type || m?.type || 'unknown').toString();
                    maintCounts[t] = (maintCounts[t] || 0) + 1;
                });
                adminAnalyticsCache.maintenanceByType = Object.keys(maintCounts).map(t => ({ type: t, count: maintCounts[t] }));
                
                // Create all charts
                createBookingsChart(bookingsOverTime);
                createRevenueChart(bookingsOverTime);
                createRoutesChart(popularRoutes);
                createClassChart(bookingsByClass);
                createUserGrowthChart(userGrowth);
                createPassengersChart(passengersPerDay);
                createBookingStatusChart(bookingsByStatus);
                createTopCustomersChart(topCustomers);

                // Internal ops charts (from mock datasets)
                createFleetStatusChart(Array.isArray(aircraftList?.items) ? aircraftList.items : []);
                createCrewStatusChart(Array.isArray(crewList?.items) ? crewList.items : []);
                createMaintenanceTypeChart(adminAnalyticsCache.maintenanceByType);

                // Heatmap (destinations)
                renderLocationHeatmap(popularRoutes);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        

        // Shift admin date range by selected granularity (Excel-like arrows)
        function shiftAdminDate(direction) {
            const startEl = document.getElementById('analyticsStart');
            const endEl = document.getElementById('analyticsEnd');
            const gran = document.getElementById('analyticsGranularity')?.value || 'day';

            // IMPORTANT: never use toISOString() for <input type="date"> values.
            // In timezones like Africa/Tunis (+01:00), midnight local time becomes
            // the previous day in UTC, causing the "forward" button to appear broken.
            const formatDateInputLocal = (d) => {
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            };
            if (!startEl || !endEl || !startEl.value || !endEl.value) {
                // initialize defaults if not set
                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - 30);
                if (startEl) startEl.value = formatDateInputLocal(start);
                if (endEl) endEl.value = formatDateInputLocal(end);
                return loadAdminData();
            }
            const start = new Date(startEl.value + 'T00:00:00');
            const end = new Date(endEl.value + 'T00:00:00');
            const dir = direction >= 0 ? 1 : -1;
            const shift = (d) => {
                const nd = new Date(d.getTime());
                if (gran === 'day') nd.setDate(nd.getDate() + 1 * dir);
                else if (gran === 'week') nd.setDate(nd.getDate() + 7 * dir);
                else if (gran === 'month') nd.setMonth(nd.getMonth() + 1 * dir);
                else if (gran === 'quarter') nd.setMonth(nd.getMonth() + 3 * dir);
                else if (gran === 'year') nd.setFullYear(nd.getFullYear() + 1 * dir);
                return nd;
            };
            const ns = shift(start);
            const ne = shift(end);
            startEl.value = formatDateInputLocal(ns);
            endEl.value = formatDateInputLocal(ne);
            loadAdminData();
        }

        let bookingsChartInstance = null;
        let revenueChartInstance = null;
        let routesChartInstance = null;
        let classChartInstance = null;
        let userGrowthChartInstance = null;
        let passengersChartInstance = null;
        let bookingStatusChartInstance = null;
        let topCustomersChartInstance = null;
        let fleetStatusChartInstance = null;
        let crewStatusChartInstance = null;
        let maintenanceTypeChartInstance = null;

        // Complementary palette (brand red + supportive colors)
        const CHART_PALETTE = [
            '#C8444A', // Tunisair red
            '#2F6FED', // blue
            '#F59E0B', // orange
            '#10B981', // green
            '#8B5CF6', // purple
            '#06B6D4', // cyan
            '#64748B', // slate
            '#E11D48', // deep red
            '#0EA5E9', // sky
            '#A3A3A3'  // gray
        ];

        function paletteFor(n) {
            return Array.from({length: n}, (_, i) => CHART_PALETTE[i % CHART_PALETTE.length]);
        }

        // Cache latest admin analytics so charts can be re-sorted client-side
        const adminAnalyticsCache = {
            bookingsOverTime: [],
            popularRoutes: [],
            bookingsByClass: [],
            userGrowth: [],
            passengersPerDay: [],
            bookingsByStatus: [],
            topCustomers: [],
            maintenanceByType: []
        };

        // Client-side chart sorting (for bar/doughnut charts)
        function setChartSort(kind, direction) {
            const dir = (direction === 'asc' || direction === 'desc') ? direction : '';
            const sortArr = (arr, key) => {
                const a = Array.isArray(arr) ? [...arr] : [];
                if (!dir) return a;
                a.sort((x, y) => {
                    const vx = Number(x?.[key] ?? 0);
                    const vy = Number(y?.[key] ?? 0);
                    return dir === 'asc' ? vx - vy : vy - vx;
                });
                return a;
            };

            if (kind === 'routes') {
                createRoutesChart(sortArr(adminAnalyticsCache.popularRoutes, 'bookings'));
                return;
            }
            if (kind === 'customers') {
                createTopCustomersChart(sortArr(adminAnalyticsCache.topCustomers, 'revenue'));
                return;
            }
            if (kind === 'class') {
                createClassChart(sortArr(adminAnalyticsCache.bookingsByClass, 'bookings'));
                return;
            }
            if (kind === 'maint') {
                createMaintenanceTypeChart(sortArr(adminAnalyticsCache.maintenanceByType, 'count'));
                return;
            }
        }
        
        function createBookingsChart(data) {
            const ctx = document.getElementById('bookingsChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (bookingsChartInstance) {
                bookingsChartInstance.destroy();
            }
            
            bookingsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDateDMY(d.date)),
                    datasets: [{
                        label: 'Bookings',
                        data: data.map(d => d.count),
                        borderColor: '#C8444A',
                        backgroundColor: 'rgba(200, 68, 74, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (revenueChartInstance) {
                revenueChartInstance.destroy();
            }
            
            revenueChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDateDMY(d.date)),
                    datasets: [{
                        label: 'Revenue (DT)',
                        data: data.map(d => d.revenue),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function createRoutesChart(data) {
            const ctx = document.getElementById('routesChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (routesChartInstance) {
                routesChartInstance.destroy();
            }
            
            routesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.route),
                    datasets: [{
                        label: 'Bookings',
                        data: data.map(d => d.bookings),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
        
        function createClassChart(data) {
            const ctx = document.getElementById('classChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (classChartInstance) {
                classChartInstance.destroy();
            }
            
            classChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.class),
                    datasets: [{
                        data: data.map(d => d.bookings),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function createUserGrowthChart(data) {
            const ctx = document.getElementById('userGrowthChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (userGrowthChartInstance) {
                userGrowthChartInstance.destroy();
            }
            
            userGrowthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDateDMY(d.date)),
                    datasets: [{
                        label: 'Total Users',
                        data: data.map(d => d.count),
                        borderColor: '#C8444A',
                        backgroundColor: 'rgba(200, 68, 74, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function createPassengersChart(data) {
            const ctx = document.getElementById('passengersChart');
            if (!ctx || !data || data.length === 0) return;
            
            if (passengersChartInstance) {
                passengersChartInstance.destroy();
            }
            
            passengersChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatDateDMY(d.date)),
                    datasets: [{
                        label: 'Passengers',
                        data: data.map(d => d.passengers),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createBookingStatusChart(data) {
            const ctx = document.getElementById('bookingStatusChart');
            if (!ctx || !data || data.length === 0 || typeof Chart === 'undefined') return;
            if (bookingStatusChartInstance) bookingStatusChartInstance.destroy();

            bookingStatusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.status),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const dataArr = ctx.chart.data.datasets[0].data || [];
                                const total = dataArr.reduce((a,b)=>a+b,0) || 1;
                                const pct = Math.round((value/total)*100);
                                return pct + '%';
                            },
                            color: '#111',
                            font: { weight: '700' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const idx = ctx.dataIndex;
                                    const revenue = data[idx]?.revenue ?? 0;
                                    return `${ctx.label}: ${ctx.raw} (Revenue DT${Number(revenue).toFixed(0)})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTopCustomersChart(data) {
            const ctx = document.getElementById('topCustomersChart');
            if (!ctx || !data || data.length === 0 || typeof Chart === 'undefined') return;
            if (topCustomersChartInstance) topCustomersChartInstance.destroy();

            topCustomersChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.username),
                    datasets: [{
                        label: 'Revenue (DT)',
                        data: data.map(d => d.revenue),
                        backgroundColor: paletteFor(data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const idx = ctx.dataIndex;
                                    return `Bookings: ${data[idx]?.bookings ?? 0}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createFleetStatusChart(aircraftItems) {
            const ctx = document.getElementById('fleetStatusChart');
            if (!ctx || !Array.isArray(aircraftItems) || aircraftItems.length === 0 || typeof Chart === 'undefined') return;
            if (fleetStatusChartInstance) fleetStatusChartInstance.destroy();

            const counts = {};
            aircraftItems.forEach(a => {
                const k = (a?.status || 'unknown').toString();
                counts[k] = (counts[k] || 0) + 1;
            });
            const labels = Object.keys(counts);
            const vals = labels.map(l => counts[l]);

            fleetStatusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data: vals, backgroundColor: paletteFor(labels.length) }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value, c) => {
                                const arr = c.chart.data.datasets[0].data || [];
                                const total = arr.reduce((a,b)=>a+b,0) || 1;
                                return Math.round((value/total)*100) + '%';
                            },
                            color: '#111',
                            font: { weight: '700' }
                        }
                    }
                }
            });
        }

        function createCrewStatusChart(crewItems) {
            const ctx = document.getElementById('crewStatusChart');
            if (!ctx || !Array.isArray(crewItems) || crewItems.length === 0 || typeof Chart === 'undefined') return;
            if (crewStatusChartInstance) crewStatusChartInstance.destroy();

            const counts = {};
            crewItems.forEach(m => {
                const k = (m?.status || 'unknown').toString();
                counts[k] = (counts[k] || 0) + 1;
            });
            const labels = Object.keys(counts);
            const vals = labels.map(l => counts[l]);

            crewStatusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{ data: vals, backgroundColor: paletteFor(labels.length) }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            formatter: (value, c) => {
                                const arr = c.chart.data.datasets[0].data || [];
                                const total = arr.reduce((a,b)=>a+b,0) || 1;
                                return Math.round((value/total)*100) + '%';
                            },
                            color: '#111',
                            font: { weight: '700' }
                        }
                    }
                }
            });
        }

        function createMaintenanceTypeChart(items) {
            const ctx = document.getElementById('maintenanceTypeChart');
            if (!ctx || !Array.isArray(items) || items.length === 0 || typeof Chart === 'undefined') return;
            if (maintenanceTypeChartInstance) maintenanceTypeChartInstance.destroy();

            maintenanceTypeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: items.map(i => i.type),
                    datasets: [{
                        label: 'Records',
                        data: items.map(i => i.count),
                        backgroundColor: paletteFor(items.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw}` } }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderLocationHeatmap(popularRoutes) {
            const container = document.getElementById('locationHeatmap');
            if (!container) return;
            const routes = Array.isArray(popularRoutes) ? popularRoutes : [];

            // Aggregate by destination
            const counts = {};
            routes.forEach(r => {
                const route = r.route || '';
                const parts = route.split('‚Üí').map(s => s.trim());
                const dest = parts.length > 1 ? parts[1] : route;
                const v = Number(r.bookings || 0);
                counts[dest] = (counts[dest] || 0) + v;
            });

            const entries = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 12);
            if (entries.length === 0) {
                container.innerHTML = '<div style="color:#888; font-size:13px;">No destination data yet.</div>';
                return;
            }
            const max = Math.max(...entries.map(e => e[1])) || 1;

            container.innerHTML = entries.map(([dest, v]) => {
                const intensity = Math.max(0.12, Math.min(0.92, v / max));
                return `
                    <div style="border-radius:14px; padding:14px; background: rgba(200, 68, 74, ${intensity}); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.08);">
                        <div style="font-weight:800; font-size:14px;">${dest}</div>
                        <div style="font-size:12px; opacity:0.95; margin-top:6px;">Bookings: <b>${v}</b></div>
                    </div>
                `;
            }).join('');
        }

        async function loadOperationsData() {
            try {
                const authHeaders = { 'Authorization': `Bearer ${accessToken}` };

                async function fetchJsonOrThrow(url) {
                    const r = await fetch(url, { headers: authHeaders });
                    const data = await r.json().catch(() => ({}));
                    if (!r.ok) {
                        let msg = 'Request failed';
                        if (typeof data?.detail === 'string') msg = data.detail;
                        else if (Array.isArray(data?.detail)) msg = data.detail.map(d => d?.msg || JSON.stringify(d)).join(' | ');
                        else if (data?.detail) msg = JSON.stringify(data.detail);
                        else if (data?.message) msg = data.message;
                        throw new Error(msg);
                    }
                    return data;
                }

                const [aircraft, crew, maintenance] = await Promise.all([
                    fetchJsonOrThrow(`${API_BASE}/aircraft`),
                    fetchJsonOrThrow(`${API_BASE}/crew`),
                    fetchJsonOrThrow(`${API_BASE}/maintenance`)
                ]);

// Display aircraft table
                const aircraftBody = document.getElementById('aircraftTableBody');
                aircraftBody.innerHTML = '';
                aircraft.items.forEach(plane => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="#" onclick="showAircraftDetailsModal('${plane.registration}'); return false;" style="color: #C8444A; font-weight: 600; text-decoration: underline;">${plane.registration}</a></td>
                        <td>${plane.model}</td>
                        <td>${plane.manufacturer}</td>
                        <td>${plane.total_seats}</td>
                        <td>${statusPill(plane.status)}</td>
                        <td>${plane.total_flight_hours.toFixed(0)}h</td>
                        <td>${plane.current_location || 'N/A'}</td>
                    `;
                    aircraftBody.appendChild(row);
                });
                
                // Display crew table
                const crewBody = document.getElementById('crewTableBody');
                crewBody.innerHTML = '';
                crew.items.slice(0, 20).forEach(member => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${member.employee_id}</td>
                        <td><a href="#" onclick="showCrewDetailsModal(${member.id}); return false;" style="color: #C8444A; font-weight: 600; text-decoration: underline;">${member.full_name}</a></td>
                        <td>${member.role}</td>
                        <td>${member.license_number || 'N/A'}</td>
                        <td>${member.total_flight_hours.toFixed(0)}h</td>
                        <td>${statusPill(member.status)}</td>
                        <td>${member.base_location}</td>
                    `;
                    crewBody.appendChild(row);
                });
                
                // Display maintenance table
                const maintenanceBody = document.getElementById('maintenanceTableBody');
                maintenanceBody.innerHTML = '';
                maintenance.items.slice(0, 20).forEach(record => {
                    const row = document.createElement('tr');
                    // Keep statuses visually consistent: scheduled (blue), delayed (red), done (green)
                    let status = record.completed ? 'done' : 'scheduled';
                    try {
                        const sched = record.scheduled_date ? new Date(record.scheduled_date) : null;
                        const exp = record.expected_finish_date ? new Date(record.expected_finish_date) : null;
                        const now = new Date();
                        const overdue = (exp && exp < now) || (sched && sched < now && !record.completed);
                        if (!record.completed && overdue) status = 'delayed';
                    } catch (_) {}
                    row.innerHTML = `
                        <td>${record.aircraft_registration || 'N/A'}</td>
                        <td>${record.maintenance_type}</td>
                        <td>${record.description.substring(0, 50)}...</td>
                        <td>${record.scheduled_date ? formatDateDMY(record.scheduled_date) : 'N/A'}</td>
                        <td>${record.expected_finish_date ? formatDateDMY(record.expected_finish_date) : 'N/A'}</td>
                        <td>${statusPill(status)}</td>
                        <td>DT${record.cost.toFixed(2)}</td>
                    `;
                    maintenanceBody.appendChild(row);
                });

                // Enable sorting for internal tables
                makeTableSortable('aircraftTable');
                makeTableSortable('crewTable');
                makeTableSortable('maintenanceTable');
            } catch (error) {
                console.error('Error loading operations data:', error);
            }
        }

        // ------------------------------
        // SIMPLE TABLE SORTING (FRONTEND)
        // ------------------------------
        function makeTableSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            // Avoid double-binding
            if (table.dataset.sortBound === 'true') return;
            table.dataset.sortBound = 'true';

            const headers = Array.from(thead.querySelectorAll('th'));

            // Preserve original order for 3rd click reset
            Array.from(tbody.querySelectorAll('tr')).forEach((r, i) => {
                if (!r.dataset.origIndex) r.dataset.origIndex = String(i);
            });

            headers.forEach((th, idx) => {
                if (!th.classList.contains('sortable')) return;
                th.addEventListener('click', () => {
                    // 3 states: none -> asc -> desc -> none
                    const current = th.dataset.sortDir || '';
                    let next = 'asc';
                    if (current === 'asc') next = 'desc';
                    if (current === 'desc') next = '';

                    headers.forEach(h => h.dataset.sortDir = '');
                    th.dataset.sortDir = next;

                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    if (!next) {
                        // reset to original order
                        rows.sort((a, b) => parseInt(a.dataset.origIndex || '0') - parseInt(b.dataset.origIndex || '0'));
                        rows.forEach(r => tbody.appendChild(r));
                        return;
                    }

                    const asc = next === 'asc';
                    rows.sort((a, b) => {
                        const va = (a.children[idx]?.innerText || '').trim();
                        const vb = (b.children[idx]?.innerText || '').trim();

                        // Try numeric compare (handles DT and h)
                        const na = parseFloat(va.replace(/[^0-9.\-]/g, ''));
                        const nb = parseFloat(vb.replace(/[^0-9.\-]/g, ''));
                        const bothNumeric = !Number.isNaN(na) && !Number.isNaN(nb);

                        if (bothNumeric) {
                            return asc ? (na - nb) : (nb - na);
                        }
                        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
                    });

                    rows.forEach(r => tbody.appendChild(r));
                });
            });
        }

        function showAircraftDetails(registration) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Aircraft Details: ${registration}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <img src="Fleet/${registration}.jpg" alt="${registration}" class="aircraft-image" 
                             onerror="this.outerHTML='<div class=\\'aircraft-image-placeholder\\'>üì∑ Aircraft Image<br/>${registration}</div>'" />
                        <div style="padding: 30px;">
                            <p style="text-align: center; color: #666; font-size: 14px;">
                                Detailed information for ${registration}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            // Prevent "[object Object]" when the backend returns structured errors.
            if (message && typeof message === 'object') {
                try {
                    message = message.detail ?? message.message ?? JSON.stringify(message);
                } catch (_) {
                    message = String(message);
                }
            }
            element.textContent = String(message ?? '');
            element.className = type === 'error' ? 'message error-message' : 'message success-message';
            element.classList.remove('hidden');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('bookingModal');
            if (event.target === modal) {
                closeBookingModal();
            }
        }
    </script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels.2.0"></script>
    
    <!-- Leaflet.js for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
function initScrollTopButton() {
    const btn = document.getElementById('scrollTopBtn');
    if (!btn) return;
    function onScroll() {
        btn.style.display = (window.scrollY > 300) ? 'block' : 'none';
    }
    window.addEventListener('scroll', onScroll);
    onScroll();
}

function parseCellValue(text) {
    const t = (text ?? '').toString().trim();
    const num = Number(t.replace(/[^0-9.\-]/g, ''));
    if (!isNaN(num) && t.match(/[0-9]/)) return num;
    const d = Date.parse(t);
    if (!isNaN(d) && t.match(/\d{4}-\d{2}-\d{2}|\d{1,2}\/\d{1,2}\/\d{2,4}/)) return d;
    return t.toLowerCase();
}

function initSortableTables() {
    document.querySelectorAll('table thead th.sortable').forEach(th => {
        if (th.querySelector('.sort-indicator')) return;
        const ind = document.createElement('span');
        ind.className = 'sort-indicator';
        ind.textContent = '‚Üï';
        th.appendChild(ind);

        th.dataset.sortState = 'none'; // none | asc | desc

        th.addEventListener('click', () => {
            const table = th.closest('table');
            if (!table) return;

            // reset other headers (3-state UI)
            table.querySelectorAll('thead th.sortable').forEach(h => {
                if (h !== th) {
                    h.dataset.sortState = 'none';
                    h.classList.remove('sorted-asc','sorted-desc');
                }
            });

            // cycle state
            const state = th.dataset.sortState;
            const next = state === 'none' ? 'asc' : (state === 'asc' ? 'desc' : 'none');
            th.dataset.sortState = next;
            th.classList.toggle('sorted-asc', next === 'asc');
            th.classList.toggle('sorted-desc', next === 'desc');

            // update indicators (3-state: ‚Üï / ‚Üë / ‚Üì) and highlight direction
            table.querySelectorAll('thead th.sortable').forEach(h => {
                const indEl = h.querySelector('.sort-indicator');
                if (!indEl) return;
                const st = h.dataset.sortState || 'none';
                indEl.textContent = st === 'asc' ? '‚Üë' : (st === 'desc' ? '‚Üì' : '‚Üï');
            });


            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const colIndex = Array.from(th.parentElement.children).indexOf(th);

            if (next === 'none') {
                // restore original order if stored
                rows.sort((a,b) => (Number(a.dataset.originalIndex) - Number(b.dataset.originalIndex)));
                rows.forEach(r => tbody.appendChild(r));
                return;
            }

            rows.forEach((r,i) => {
                if (!r.dataset.originalIndex) r.dataset.originalIndex = String(i);
            });

            rows.sort((ra, rb) => {
                const a = parseCellValue(ra.children[colIndex]?.innerText);
                const b = parseCellValue(rb.children[colIndex]?.innerText);
                if (a < b) return next === 'asc' ? -1 : 1;
                if (a > b) return next === 'asc' ? 1 : -1;
                return 0;
            });
            rows.forEach(r => tbody.appendChild(r));
        });
    });
}

function statusPill(status) {
    const s = (status || '').toString().toLowerCase();
    let cls = 'status-pill ';
    // Generic + internal ops mappings
    if (s.includes('scheduled') || s.includes('boarding') || s.includes('on_duty') || s.includes('departed')) cls += 'status-scheduled';
    else if (s.includes('delayed') || s.includes('cancel') || s.includes('maintenance') || s.includes('grounded') || s.includes('on_leave')) cls += 'status-delayed';
    else if (s.includes('done') || s.includes('completed') || s.includes('confirmed') || s.includes('operational') || s.includes('available') || s.includes('landed')) cls += 'status-done';
    else cls += 'status-scheduled';
    return `<span class="${cls}">${status}</span>`;
}
</script>

    <button id="scrollTopBtn" title="Back to top" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚Üë</button>
</body>
</html>
